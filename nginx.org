#+TITLE: NGINX代码导读
#+AUTHOR: sqlfocus


* 入口
*文件* main():~/src/core/nginx.c

* 信号处理
*函数入口* =ngx_signal_process():~/src/os/unix/ngx_process.c=

对应命令行参数-s

* 时间缓存
*函数* ~ngx_time_init()~ : =~/src/core/ngx_times.c=

nginx中的时间以秒为粒度，被缓存起来，并形成丰富的字符串格式；此设计使得
少更新多读取的时间操作尤其高效。

缓存时间设定了定量的槽位，构成缓存循环队列；以免某些请求的处理时间大于s
的粒度，造成紊乱。

* 插口继承
*函数* =ngx_add_inherited_sockets()= :~/src/core/nginx.c

启动nginx时，可通过环境变量NGINX继承已有的socket插口

* 初始化插口
  - listen配置解析     :: =ngx_http_core_listen():~/src/http/ngx_http_core_module.c=
  - 建立监听插口结构   :: =ngx_http_optimize_servers():~/src/http/ngx_http.c=
  - 建立监听链路       :: =ngx_open_listening_sockets():~/src/core/ngx_connection.c=
  - 根据listen配置设置链路属性  :: =ngx_configure_listening_sockets():~/src/core/ngx_connection.c=

  #+BEGIN_EXAMPLE
  调用流程
  -main()                                          ~/src/core/nginx.c
     -ngx_init_cycle()                             ~/src/core/ngx_cycle.c
        -ngx_conf_parse()
           -ngx_http_block()                       ngx_http_module模块儿解析
              -ngx_http_core_server()              server{}解析
                 -ngx_http_core_listen()           listen配置解析
                 -...
                 -ngx_http_add_listen()            解析结果挂接入配置系统
              -ngx_http_optimize_servers()         创建监听插口结构
        -...
        -ngx_open_listening_sockets()              创建链路
        -ngx_configure_listening_sockets()         配置链路
  #+END_EXAMPLE

* 配置解析
  - 入口函数           :: =ngx_conf_parse():~/src/core/ngx_conf_file.c=
  - http{}入口函数     :: =ngx_http_block():~/src/http/ngx_http.c=
  - server{}入口函数   :: =ngx_http_core_server():~/src/http/ngx_http_core_module.c=
  - location{}入口函数 :: =ngx_http_core_location():~/src/http/ngx_http_core_module.c=

#+CAPTION: 四级指针视图
[[file:ngx_http_module-http{}.png]]

#+CAPTION: SERVER上下文视图
[[file:ngx_http_core_module-server{}.png]]

#+CAPTION: LOCATION上下文视图
[[file:ngx_http_core_module-location{}.png]]

#+CAPTION: location优化后视图
[[file:ngx_http_core_module-loc_conf-optimization.png]]

[[http://blog.csdn.net/xiaofei0859/article/details/51848897][参考网址]]

* 模块儿初始化流程
#+BEGIN_EXAMPLE
--main()                        入口，~/src/core/nginx.c
    --ngx_preinit_modules()         初始化ngx_modules[].index及模块儿名
    --ngx_init_cycle()              配置解析
        --ngx_cycle_modules()           创建模块儿的配置环境, 并初始化
        --ngx_modules[]->ctx->create_conf()  
                                        NGX_CORE_MODULE类型模块创建配置环境,ngx_cycle->conf_ctx[]
        --ngx_conf_parse()
            --ngx_conf_handler()            解析配置主入口，ngx_conf_file.c
                                            其中涉及模块儿配置信息结构的内存分配等
                -- 查找ngx_cycle_t->modules[]->commands[]
                   获取对应的处理命令
                -- 调用命令->set()
        --ngx_modules[]->ctx->init_conf()    
                                        未配置的项采用默认值
        --ngx_init_modules()            模块儿启动前的特殊准备，主要针对集成的第三方
            --ngx_cycle_t->modules[]->init_module()
    ---------------单进程模式---------------
    --ngx_single_process_cycle()
        --ngx_modules[]->init_process() 模块儿进程级初始化(所有)
    -----------master+worker模式------------
    --ngx_master_process_cycle()
        --ngx_start_worker_processes()
            --ngx_worker_process_cycle()              fork()后，worker进程的执行入口点
                --ngx_worker_process_init()
                    --ngx_modules[]->init_process()   ~/src/os/unix/ngx_process_cycle.c
#+END_EXAMPLE

* handle phase
  - 阶段名              :: =ngx_http_phases:~/src/http/ngx_http_core_module.h=
  - 注册                :: =各模块儿ngx_module_t->ctx->postconfiguration()=
  - 优化排序            :: =ngx_http_init_phase_handlers():~/src/http/ngx_http.c=
  - 执行入口            :: =ngx_http_core_run_phases():~/src/http/ngx_http_core_module.c=

  #+BEGIN_EXAMPLE
  此四阶段不能挂接回调函数
    NGX_HTTP_FIND_CONFIG_PHASE
    NGX_HTTP_POST_REWRITE_PHASE
    NGX_HTTP_POST_ACCESS_PHASE
    NGX_HTTP_TRY_FILES_PHASE

  流程
  -ngx_init_cycle()
     -ngx_conf_parse()
        -ngx_http_block()
           -递归解析
           -ngx_module_t->ctx->postconfiguration()
           -ngx_http_init_phase_handlers()
     -...
  -for(;;)                                     worker处理循环
     -ngx_process_events_and_timers()
     -ngx_event_process_posted()
        -ngx_http_init_connection()
        -...
        -???ngx_http_core_run_phases()
  #+END_EXAMPLE
* worker进程
*入口函数* =ngx_worker_process_cycle():~/src/os/unix/ngx_process_cycle.c=

* 高速IO模型
  - 初始化入口           : =ngx_event_process_init():~/src/event/ngx_event.c=
  - worker主循环处理入口 : =ngx_process_events_and_timers():~/src/event/ngx_event.c=
  - EPOLL事件处理入口    : =ngx_epoll_process_events():~/src/event/modules/ngx_epoll_module.c=
  - ACCEPT事件处理入口   : =ngx_event_accept():~/src/event/ngx_event_accept.c=
  

  #+BEGIN_EXAMPLE
  -ngx_init_cycle()
     -ngx_conf_parse()
        -ngx_events_block()                      events{}解析，ngx_event.c
     -ngx_init_modules()
        -ngx_event_module_init()
  -ngx_master_process_cycle()
     -ngx_start_worker_processes()
        -ngx_spawn_process()
           -fork()
           -ngx_worker_process_cycle()           worker进程执行入口
              -ngx_worker_process_init()
                 -ngx_event_process_init()
                    -初始化事件队列
                    -ngx_epoll_init()
                       -epoll_create()
                       -创建epoll事件结构数组
                       -设置底层IO句柄ngx_os_io
                       -设置数据处理句柄ngx_epoll_module_ctx.actions
                    -读、写信息链表
                    -建立监听链路结构与请求结构读对应关系
                    -设置ACCEPT事件处理句柄ngx_event_accept/ngx_event_recvmsg
              -for(;;)                          worker处理循环
                 -ngx_process_events_and_timers()
                    -ngx_trylock_accept_mutex() 添加待监控链路到EPOLL系统
                    -ngx_process_events()       处理
                    -ngx_event_process_posted()
    #+END_EXAMPLE

* 变量
变量指nginx配置中使用的可变符号，以$开头；nginx推出变量机制，是为方便用户根据
实时环境定制复杂的控制逻辑。
  - 仅支持字符串类型的变量 
  - 赋值为自动赋值、惰性赋值
  - 内部变量为预定义的
  - 也支持外部变量(自定义变量)

  #+BEGIN_EXAMPLE
  -ngx_init_cycle()
    -ngx_conf_parse()
      -ngx_http_block()                  解析http{}入口
        -ngx_http_module_t->preconfiguration() 
                                         在http{}解析前调用, 将各个模块儿支持
                                           的变量加入ngx_http_core_main_conf_t
                                           ->variables_keys, 此处为内
                                           部变量，如ngx_http_core_variables[]
        -ngx_conf_parse()                递归调用解析http内容，配置文件中的外
          -ngx_http_rewrite_set()          部变量，也加入->variables_keys，如
            -ngx_http_add_variable()       ngx_http_rewrite_module模块儿的"set"
            -ngx_http_get_variable_index() 指令，同时也加入->variables表
        -...
        -ngx_http_variables_init_vars()  合法性检测
  ----------------------------------------------------
  -ngx_http_init_connection()            ~/src/http/ngx_http_request.c
    -ngx_http_wait_request_handler()     接收请求
      -ngx_http_create_request()         创建请求信息结构ngx_http_request_t
        -ngx_pcalloc()                   分配内存ngx_http_request_t->variables，
                                           代表可能的变量值，对应变量名
                                           ngx_http_core_main_conf_t->variables
                                           因此它们的索引一致
      -ngx_http_process_request_line()
        -ngx_http_process_request_headers()
          -ngx_http_process_request()
            -ngx_http_handler()
              -ngx_http_core_run_phases()
                -ngx_http_rewrite_handler()    重写阶段入口函数，设置需要的变量值
            -ngx_http_run_posted_requests()
  #+END_EXAMPLE

  #+BEGIN_EXAMPLE
  对应指令"set $arg_a 30;"的脚本流程
  -ngx_http_rewrite_set()                "set"指令处理入口，~/src/http/modules/ngx_http_rewrite_module.c
    -ngx_http_rewrite_value()            构建脚本引擎
  
  脚本执行流程, NGX_HTTP_REWRITE_PHASE阶段
  -ngx_http_rewrite_handler()            脚本引擎处理句柄入口，ngx_http_rewrite_module.c
  #+END_EXAMPLE

* HTTP请求处理
以下函数列表顺序，代表了HTTP请求的处理顺序
  - 处理入口             :: =ngx_http_init_connection():~/src/http/ngx_http_request.c=
  - 接收请求头           :: =ngx_http_wait_request_handler()=
  - 处理请求行           :: =ngx_http_process_request_line()=
  - 处理请求头           :: =ngx_http_process_request_headers()=
  - HTTP请求处理入口     :: =ngx_http_process_request()=
  - phase handler入口    :: =ngx_http_core_run_phases()=
  - 当前处理完毕后，触发子请求   :: =ngx_http_run_posted_requests()=

* filter模块儿
对于http请求处理handler产生的响应内容，在发送给客户端前，需过滤处理；这
些过滤模块儿对于增强功能、提升性能非常必要。

由于http数据包括头部和内容两部分，因此过滤模块儿对应的处理函数也一般有
两个，分别对应header和body；这些函数组成两条过滤链，分别由指针变量
=ngx_http_top_header_filter= 和 =ngx_http_top_body_filter= 索引。

** 过滤链的形成机理
  #+BEGIN_EXAMPLE
  定义链表首元素指针                        ~/src/http/ngx_http.c
  ngx_http_output_header_filter_pt  ngx_http_top_header_filter;
  ngx_http_output_body_filter_pt    ngx_http_top_body_filter;
  ngx_http_request_body_filter_pt   ngx_http_top_request_body_filter;
  #+END_EXAMPLE

  #+BEGIN_EXAMPLE
  注册链表的起始模块儿，注册完成后链表的尾模块儿
  ngx_http_write_filter_module
  ngx_http_header_filter_module
  #+END_EXAMPLE

  #+BEGIN_EXAMPLE
  各filter模块儿定义局部指针
  static ngx_http_output_header_filter_pt  ngx_http_next_header_filter;
  static ngx_http_output_body_filter_pt    ngx_http_next_body_filter;
 
  利用以下串联关系，组成单链表；先注册的最终将靠近链表尾端，后执行
  ngx_http_next_header_filter = ngx_http_top_header_filter;
  ngx_http_top_header_filter = xxx_filter;
  #+END_EXAMPLE

** 被调用流程
  #+BEGIN_EXAMPLE
  发送头部、内容一般在内容处理模块儿被调用
  -ngx_http_send_header()
    -ngx_http_top_header_filter()        首部过滤链入口
  -ngx_http_output_filter()
    -ngx_http_top_body_filter()          尾部过滤链入口
  #+END_EXAMPLE

